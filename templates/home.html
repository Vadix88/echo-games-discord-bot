<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
        <meta name="google-site-verification" content="XJCZ921Q8eko4STzYrhKwV8DmDpdBQGob8K3Gi3r4yM"/>
        <meta name="description" content="{{ desc }}"/>
        <meta name="author" content="{{ author }}"/>
        <title>{{ title }}</title>

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

        <link rel="icon" href="/static/icon.png">
        <style type="text/css">
            @media only screen and (max-width: 23.5rem) {
                .navbar-brand {
                    font-size: 1rem
                }

                {% if admin %}
                #mergeSpan,
                #mergeModalOpen {
                    display: none;
                }

                .merging #mergeSpan,
                .merging #mergeModalOpen {
                    display: block;
                }

                .mergingOnOffLabel {
                    color: #fff;
                    margin-bottom: 0;
                }

                #mergingOnOff {
                    height: 15px;
                    width: 15px;
                }

                #mergeConfirmModalRequestList .btn,
                #mergeConfirmModalTargetRequest .btn,
                #mergeModalRequestList .request .btn {
                    cursor: default;
                }

                #mergeConfirmModalRequestList .listSymbol {
                    width: 1rem;
                }

                #mergeConfirmModalTargetRequest {
                    border-bottom: 1px solid black;
                }
                {% endif %}
            }
        </style>
    </head>
    <body>

        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>

        <nav class="navbar sticky-top navbar-expand-md navbar-dark bg-dark">
            <a class="navbar-brand" href="/">Echo VR Feature Requests</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="ml-auto collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="navbar-item">
                        <a class="btn btn-primary text-nowrap" {% if username is defined %}data-toggle="modal" data-target="#requestmodal" href=""{% else %}href="/login"{% endif %}>Create Feature Request</a>
                    </li>
                    {% if admin %}
                    <li class="navbar-item" id="mergeModalOpen">
                        <a class="btn btn-warning text-nowrap ml-2" data-toggle="modal" data-target="#mergeModal" href=""
                            onclick="refreshMergeModalList()">Show requests to merge</a>
                    </li>
                    {% endif %}
                </ul>
                <ul class="navbar-nav ml-auto">
                    {% if admin %}
                    <li class="navbar-item d-flex align-items-center pr-5">
                        <label class="mergingOnOffLabel" for="mergingOnOff">Request merging on/off&nbsp;</label>
                        <input type="checkbox" id="mergingOnOff" onclick="setMergingOnOff()">
                    </li>
                    {% endif %}
                    <li class="navbar-item d-flex align-items-center">
                        {% if username is defined %}
                        <img class="rounded" src="{{ avatar }}" style="height: 2em; width: 2em">
                        {% endif %}
                        <span class="navbar-text ml-1 mr-3">{% if username is defined %}{{ username }}{% else %}Not logged in{% endif %}</span>
                    </li>
                    <li class="navbar-item mt-2 mt-md-0">
                        {% if username is undefined %}
                        <a class="btn btn-primary" role="Button" href="/login">Log In</a>
                        {% else %}
                        <a class="btn btn-primary" role="Button" href="/logout">Log Out</a>
                        {% endif %}
                    </li>
                </ul>
            </div>
        </nav>

        <div class="modal fade" id="requestmodal" role="dialog" aria-labelledby="requestlabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="requestlabel">New request</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body">
                        <form method="post" action="/api/newrequest">
                            <div class="form-group">
                                <input class="form-control" type="text" placeholder="Title" name="title" maxlength="100" required>
                            </div>
                            <div class="form-group">
                                <select class="form-control" name="mode" required>
                                    <option value="" hidden>Game Mode</option>
                                    <option value="ea">Echo Arena</option>
                                    <option value="ec">Echo Combat</option>
                                    <option value="n/a">Not Applicable</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <textarea class="form-control" name="description" placeholder="description" rows="5" maxlength="1700" required></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {% if admin %}
        <div class="modal fade" id="mergeModal" tabindex="-1" role="dialog" aria-labelledby="mergeModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg" style="height: 85vh;">
                <div class="modal-content h-100">
                    <div class="modal-header p-2 pl-3">
                        <h5 class="modal-title" id="mergeModalLabel">Request merging</h5>
                        <button type="button" class="btn btn-sm btn-outline-danger ml-auto" onclick="clearSelectionList()">Clear all</button>
                        <button type="button" class="close ml-1" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body p-2" style="overflow-y: scroll;">
                        <ul id="mergeModalRequestList" class="pl-0">
                        </ul>
                    </div>
                    <div class="modal-footer p-2">
                        <button type="button" class="btn btn-sm btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="mergeConfirmModal" tabindex="-1" role="dialog" aria-labelledby="mergeConfirmModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg" style="height: 85vh;">
                <div class="modal-content h-100">
                    <div class="modal-header p-2 pl-3">
                        <h5 class="modal-title" id="mergeConfirmModalLabel">Confirm merge</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body p-2" style="overflow-y: scroll;">
                        <div class="ml-4">To:</div>
                        <div id="mergeConfirmModalTargetRequest" class="d-flex w-100 mb-2 pb-1 pl-4">
                        </div>
                        <div class="ml-4">From:</div>
                        <ul id="mergeConfirmModalRequestList" class="pl-4">
                        </ul>
                    </div>
                    <div class="modal-footer p-2">
                        <button type="button" id="confirmMergeButton" class="btn btn-sm btn-primary"
                            data-targetindex="" onclick="mergeSelectedToTarget(event)">Merge</button>
                        <button type="button" class="btn btn-sm btn-secondary" data-dismiss="modal" onclick="cancelMerge()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if error is not none %}
        <div class="container mt-3">
            <div class="alert alert-danger" role="alert">
                {{ error }}
            </div>
        </div>
        {% endif %}

        {% if success is not none %}
        <div class="container mt-3">
            <div class="alert alert-success" role="alert">
                {{ success }}
            </div>
        </div>
        {% endif %}

        {% if username is not defined %}
        <div class="container mt-3">
            <div class="alert alert-success" role="alert">
                Please <a href="/login">log in</a> if you want to vote on requests and see which you have already voted on!
            </div>
        </div>
        {% endif %}

        {% if admin %}
        <div class="container mt-3">
            <div class="jumbotron">
                <h1>Welcome Admin!</h1>
                <p>You have a couple more options here than the average user:</p>
                <ul>
                    <li><p>Change the status of all requests. Overrides any status set from discord if it's anything other than Open. This is done in the details popup.</p></li>
                    <li><p>Remove any request. This is semi-permanent, you will have to contact me if you want to reverse it. This is also done in the details popup.</p></li>
                    <li><p>Add a developer response to any request. Your name will be visible on it. Again, semi-permanent, contact me to reverse. Also, you guessed it, this is also done in the details popup.</p></li>
                    <li><p>NEW: Merging requests. If you find a duplicate request, you can merge it into the one it duplicates using the details popup. All current votes from the duplicate request will be moved to the request it is merged into, and the duplicate is automatically removed. All future votes through discord on the duplicate are ignored. This operation is a pain to reverse, so make sure you are certain before merging. With two requests that duplicate each other, it's not that important which one gets merged into which, but I would say the best option is keeping the more descriptive one or the one with significantly more votes.</p></li>
                </ul>
                <p>Remember that most of these functions are also available on discord:</p>
                <ul>
                    <li><p>React on the message with &#128467;, &#9989;, &#10060; or nothing to set the request to planned, implemented, rejected or open respectively.</p></li>
                    <li><p>React on the message with &#9940; to remove it from this website and the spreadsheet.</p></li>
                    <li><p>Prefix you response with the message id of the message to add a developer response. An example response looks like this: "123456789012345678 this is the dev response". The message id can be obtained from the spreadsheet or by enabling developer mode in discord under Appearance and right clicking the message.</p></li>
                </ul>
                <p>If something doesn't work, dont hesitate to contact me. I'll be happy to fix it.</p>
                <p>Contact: mateuszdrwal#9960 on discord, drwal.mateusz@gmail.com otherwise.</p>
            </div>
        </div>
        {% endif %}

        <div class="container mt-3">
            <span class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" id="sort" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Sort</button>
                <div class="dropdown-menu" aria-labelledby="sort">
                    <button class="dropdown-item" type="button" onclick="sort = 0; $('#sort')[0].innerHTML = this.innerHTML; setTimeout(sortRequests, 10);">Net votes descending</button>
                    <button class="dropdown-item" type="button" onclick="sort = 1; $('#sort')[0].innerHTML = this.innerHTML; setTimeout(sortRequests, 10);">Net votes ascending</button>
                    <button class="dropdown-item" type="button" onclick="sort = 2; $('#sort')[0].innerHTML = this.innerHTML; setTimeout(sortRequests, 10);">Recent</button>
                    <button class="dropdown-item" type="button" onclick="sort = 3; $('#sort')[0].innerHTML = this.innerHTML; setTimeout(sortRequests, 10);">Old</button>
                </div>
            </span>
            <span class="dropdown ml-2">
                <button class="btn btn-primary dropdown-toggle" type="button" id="filter" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Filter</button>
                <div class="dropdown-menu" aria-labelledby="filter">
                    <button class="dropdown-item" type="button" onclick="filter = 0; $('#filter')[0].innerHTML = this.innerHTML; filterRequests();">All</button>
                    <button class="dropdown-item" type="button" style="background-color: #ffeeba" onclick="filter = 1; $('#filter')[0].innerHTML = this.innerHTML; filterRequests();">Planned</button>
                    <button class="dropdown-item" type="button" style="background-color: #c3e6cb" onclick="filter = 2; $('#filter')[0].innerHTML = this.innerHTML; filterRequests();">Implemented</button>
                    <button class="dropdown-item" type="button" style="background-color: #f5c6cb" onclick="filter = 3; $('#filter')[0].innerHTML = this.innerHTML; filterRequests();">Rejected</button>
                    <button class="dropdown-item" type="button" style="background-color: #d6d8db" onclick="filter = 7; $('#filter')[0].innerHTML = this.innerHTML; filterRequests();">Not applicable anymore</button>
                    <button class="dropdown-item" type="button" onclick="filter = 4; $('#filter')[0].innerHTML = this.innerHTML; filterRequests();">Open</button>
                    <button class="dropdown-item" type="button" onclick="filter = 5; $('#filter')[0].innerHTML = this.innerHTML; filterRequests();">Popular</button>
                    <button class="dropdown-item" type="button" onclick="filter = 6; $('#filter')[0].innerHTML = this.innerHTML; filterRequests();">Unpopular</button>
                    <button class="dropdown-item" type="button" onclick="filter = 8; $('#filter')[0].innerHTML = this.innerHTML; filterRequests();">Responded</button>
                    {% if username is defined %}
                    <button class="dropdown-item" type="button" onclick="filter = 9; $('#filter')[0].innerHTML = this.innerHTML; filterRequests();">Mine</button>
                    {% endif %}
                </div>
            </span>
        </div>

        <div class="container">
            <ul class="list-group mt-3 mb-3" id="requestList"></ul>
        </div>

        <div class="fixed-bottom"><a class="badge badge-secondary mb-1 ml-1" href="https://github.com/mateuszdrwal/echo-games-discord-bot" target="_blank"><img src="/static/GitHub-Mark-64px.png" height=32 class="mr-2">Contribute on github!</a></div>

        <template id="modalTemplate">
            <div class="modal fade" id="details" role="dialog" aria-labelledby="title" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="title"></h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        </div>
                        <div class="modal-body">
                            <b>Author:</b> $author<br/>
                            <b>Created at:</b> $time<br/>
                            <b>Status:</b> $status<br/>
                            <b>Mode:</b> $mode<br/>
                            <b>Description:</b> $description<br/><br/>
                            <b>Net votes:</b> $points<br/>
                            <b>Upvotes:</b> $upvotes<br/>
                            <b>Downvotes:</b> $downvotes<br/><br/>
                            <b>Developer responses:</b><br/>$devresp
                        </div>
                        <div class="modal-footer flex-wrap">
                            <textarea id="copy" style="display: none;"></textarea>
                            <button id="shareButton" type="button" class="btn btn-primary mb-3" onclick="var copy = $('#copy')[0]; copy.style.display = 'inline'; copy.innerHTML = window.location.origin+'/request/request.mid'; copy.select(); document.execCommand('Copy'); copy.style.display = 'none'; copy.innerHTML = ''; this.innerHTML = 'Link copied!';">Share</button>
                        {% if admin %}
                            <span class="dropdown mb-3">
                                <button class="btn btn-primary dropdown-toggle" type="button" id="devresp" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
                                <div class="dropdown-menu" aria-labelledby="devresp">
                                    <button class="dropdown-item" type="button" data-dismiss="modal" onclick="status('request.mid', 0);">Open</button>
                                    <button class="dropdown-item" type="button" data-dismiss="modal" onclick="status('request.mid', 3);">Implemented</button>
                                    <button class="dropdown-item" type="button" data-dismiss="modal" onclick="status('request.mid', 2);">Rejected</button>
                                    <button class="dropdown-item" type="button" data-dismiss="modal" onclick="status('request.mid', 1);">Planned</button>
                                    <button class="dropdown-item" type="button" data-dismiss="modal" onclick="status('request.mid', 4);">Not applicable anymore</button>
                                </div>
                            </span>
                            <span class="dropdown mb-3">
                                <button class="btn btn-primary dropdown-toggle" type="button" id="mode" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Mode</button>
                                <div class="dropdown-menu" aria-labelledby="mode">
                                    <button class="dropdown-item" type="button" data-dismiss="modal" onclick="mode('request.mid', 'ea');">Echo Arena</button>
                                    <button class="dropdown-item" type="button" data-dismiss="modal" onclick="mode('request.mid', 'ec');">Echo Combat</button>
                                    <button class="dropdown-item" type="button" data-dismiss="modal" onclick="mode('request.mid', 'n/a');">Not Applicable</button>
                                </div>
                            </span>
                            <button type="button" class="btn btn-primary mb-3" data-dismiss="modal" onclick="var resp = prompt('type your respone here'); if (resp != null) {devresp('request.mid', resp);}">Add developer response</button>
                            <button type="button" class="btn btn-danger mb-3" data-dismiss="modal" onclick="if (confirm('Are you sure you want to remove this request?')) {remove('request.mid')}">Remove request</button>
                            <button type="button" class="btn btn-danger mb-3" data-dismiss="modal" onclick="merge()">Merge requests</button>
                        {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <template id="requestTemplate">
            <li class="list-group-item request" id="" data-votesup="" data-votesdown="">
                <div class="d-flex w-100 justify-content-between" id="requestHeader">
                    <div>
                        <h5 class="mb-1" id="title"></h5>
                    </div>
                    <small class="text-nowrap" id="smallText" style="text-align: right;"></small>
                </div>
                <p style="margin-bottom: 0.2em" id="description"></p>
                <div class="d-flex justify-content-between flex-wrap" id="requestFooter">
                    <small style="margin-bottom: 0.2em" id="author"></small>
                    <div class="d-flex flex-nowrap ml-auto">
                        {% if admin %}
                        <span class="ml-2" id="mergeSpan">
                            <button type="button" class="btn btn-warning" onclick="addRequestToList(this)" id="selectToMergeButton" requestId="">Select to merge</button>
                        </span>
                        {% endif %}
                        <span class="ml-2" id="detailsSpan">
                            <button type="button" class="btn btn-primary" onclick="" id="detailsButton">Details</button>
                        </span>
                        <span class="mr-1 ml-1" id="upSpan">
                            <button type="button" id="upButton" class="btn btn" onclick="" style="width: 5em;"></button>
                        </span>
                        <span id="downSpan">
                            <button type="button" id="downButton" class="btn btn" onclick="" style="width: 5em;"></button>
                        </span>
                    </div>
                </div>
                <div class="alert alert-primary mt-3" role="alert" id="devresp"></div>
            </li>
        </template>

        {% if admin %}
        <script type="text/javascript">
            function status(id, target) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.responseText == "OK") {
                        updateSingleRequest(id);
                        console.log("success");
                    }
                }
                xhttp.open("POST", "/api/status?id="+id+"&target="+target, true);
                xhttp.send();
                console.log("updating status");
            }
            function mode(id, target) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.responseText == "OK") {
                        updateSingleRequest(id);
                        console.log("success");
                    }
                }
                xhttp.open("POST", "/api/mode?id="+id+"&target="+target, true);
                xhttp.send();
                console.log("updating mode");
            }
            function remove(id) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.responseText == "OK") {
                        updateSingleRequest(id);
                        console.log("success");
                    }
                }
                xhttp.open("POST", "/api/remove?id="+id, true);
                xhttp.send();
                console.log("removing");
            }
            function devresp(id, resp) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.responseText == "OK") {
                        updateSingleRequest(id);
                        console.log("success");
                    }
                }

                data = new FormData
                data.append("id", id)
                data.append("devresp", resp)

                xhttp.open("POST", "/api/devresp", true);
                xhttp.send(data);
                console.log("responding");
            }
            function merge(id, id_from) {
                
                var resp = prompt('In the box below, paste the direct link to the request which should be merged into this one. All votes from the linked request will be transfered into this one and the linked request will be automatically removed.');
                var matches = resp.match(/(\d{16,20})/);

                if (matches == null) {
                    alert("Could not extract request id from the link.");
                    return;
                }

                var from_request = requestList[matches[1]];
                
                if (from_request == undefined) {
                    alert("Could not find that request.");
                    return;
                }

                if (!confirm('Are you sure you want to move the votes from the "' + from_request["title"] + '" request to this one and remove that request in the process?')) {
                    return;
                }

                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.responseText == "OK") {
                        updateSingleRequest(modal_id);
                        updateSingleRequest(matches[1]);
                        console.log("success");
                    }
                }

                data = new FormData
                data.append("id", modal_id)
                data.append("id_from", matches[1])

                xhttp.open("POST", "/api/merge", true);
                xhttp.send(data);
                console.log("merging");
            }
        </script>
        {% endif %}
        {% if username is defined %}
        <script type="text/javascript">
            function flip(i) {
                if (i) {return 0} else {return 1}
            }

            function vote(id, target, up) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.responseText == "OK") {
                        updateSingleRequest(id);
                        console.log("success");
                    }
                }
                xhttp.open("POST", "/api/vote?id="+id+"&target="+flip(target)+"&up="+up, true);
                xhttp.send();
                console.log("voting");
            }
        </script>
        {% else %}
        <script type="text/javascript">
            function vote(id, target, up) {
                window.location.href = "/login";
            }
        </script>
        {% endif %}

        <script type="text/javascript">

            var sort = 0;
            var filter = 0;
            var requestList = {};
            var modal_id;

            function createRequestsFromJson(data) {
                data = JSON.parse(data);
                requestList = data;
                $(".request").remove()
                Object.values(data).forEach(function (request) {
                    template = createRequest(request)
                    $("#requestList").append(template);
                });
            }

            function createRequest(request) {
                var template = $($("#requestTemplate").clone().prop("content"));
                    
                    template.find("li")[0].attributes["class"].value += [""," list-group-item-warning"," list-group-item-danger"," list-group-item-success"," list-group-item-secondary"][request.statusCode];
                    template.find("#title")[0].innerHTML = request.title;
                    template.find("#smallText")[0].innerHTML = request.date + "<br/>" + ((request.status == "Open") ? "Status: " + request.status : "<b>Status: " + request.status + "</b>");
                    template.find("#description")[0].innerHTML = request.description;
                    template.find("#author")[0].innerHTML = request.author;

                    if (request.vote.upDiscord || request.self) {
                        var attr = document.createAttribute("data-toggle");
                        attr.value = "tooltip";
                        template.find("#upSpan")[0].setAttributeNode(attr);

                        var attr = document.createAttribute("data-placement");
                        attr.value = "bottom";
                        template.find("#upSpan")[0].setAttributeNode(attr);

                        var attr = document.createAttribute("title");
                        attr.value = (request.self) ? "You cannot vote for yourself." : "This vote has been placed from discord. If you want to remove the vote from this suggestion please do so on discord in the #echovr-feature-request channel.";
                        template.find("#upSpan")[0].setAttributeNode(attr);
                    }

                    upButton = template.find("#upButton")[0]
                    upButton.attributes["class"].value += (!request.vote.up) ? "-outline-success" : "-success";
                    upButton.attributes["onclick"].value = "vote('" + request.mid + "', " + request.vote.up + ", 1);";
                    upButton.attributes["style"].value += (request.vote.upDiscord || request.self) ? "pointer-events: none;" : "";
                    upButton.disabled = (request.vote.upDiscord || request.self);
                    upButton.innerHTML = request.up + " &#x1F44D;";

                    if (request.vote.downDiscord || request.self) {
                        var attr = document.createAttribute("data-toggle");
                        attr.value = "tooltip";
                        template.find("#downSpan")[0].setAttributeNode(attr);

                        var attr = document.createAttribute("data-placement");
                        attr.value = "bottom";
                        template.find("#downSpan")[0].setAttributeNode(attr);

                        var attr = document.createAttribute("title");
                        attr.value = (request.self) ? "You cannot vote for yourself." : "This vote has been placed from discord. If you want to remove the vote from this suggestion please do so on discord in the #echovr-feature-request channel.";
                        template.find("#downSpan")[0].setAttributeNode(attr);
                    }

                    downButton = template.find("#downButton")[0]
                    downButton.attributes["class"].value += (!request.vote.down) ? "-outline-danger" : "-danger";
                    downButton.attributes["onclick"].value = "vote('" + request.mid + "', " + request.vote.down + ", 0);";
                    downButton.attributes["style"].value += (request.vote.downDiscord || request.self) ? "pointer-events: none;" : "";
                    downButton.disabled = (request.vote.downDiscord || request.self);
                    downButton.innerHTML = request.down + " &#x1F44E;";

                    template.find("#detailsButton")[0].attributes["onclick"].value = "detailsModal('" + request.mid + "');";

                    template.find("#devresp")[0].innerHTML = request.devresp;
                    if (request.devresp == "") {template.find("#devresp")[0].remove()}

                    var attr = document.createAttribute("data-sort");
                    attr.value = request.up - request.down;
                    template.find("li")[0].setAttributeNode(attr);

                    var attr = document.createAttribute("data-age");
                    attr.value = request.timestamp;
                    template.find("li")[0].setAttributeNode(attr);

                    template.find("li")[0].attributes["id"].value = request.mid;
                    
                    template.find("#selectToMergeButton")[0].attributes["requestId"].value = request.mid;

                    template.find("li")[0].attributes["data-votesUp"].value = request.up;
                    template.find("li")[0].attributes["data-votesDown"].value = request.down;

                    return template
            }

            function sortFuncVotes(a,b) {
                var aval = $(a).data("sort")
                var bval = $(b).data("sort")
                if (aval == bval) {
                    return ($(a).find("#title")[0].innerHTML.toLowerCase() > $(b).find("#title")[0].innerHTML.toLowerCase()) ? 1 : -1
                }
                return bval - aval
            }

            function sortFuncNegativeVotes(a,b) {
                var aval = $(a).data("sort")
                var bval = $(b).data("sort")
                if (aval == bval) {
                    return ($(a).find("#title")[0].innerHTML.toLowerCase() > $(b).find("#title")[0].innerHTML.toLowerCase()) ? 1 : -1
                }
                return aval - bval
            }

            function sortFuncNew(a,b) {
                var aval = $(a).data("age")
                var bval = $(b).data("age")
                if (aval == bval) {
                    return ($(a).find("#title")[0].innerHTML.toLowerCase() > $(b).find("#title")[0].innerHTML.toLowerCase()) ? 1 : -1
                }
                return bval - aval
            }

            function sortFuncOld(a,b) {
                var aval = $(a).data("age")
                var bval = $(b).data("age")
                if (aval == bval) {
                    return ($(a).find("#title")[0].innerHTML.toLowerCase() > $(b).find("#title")[0].innerHTML.toLowerCase()) ? 1 : -1
                }
                return aval - bval
            }

            function sortRequests() {
                var sortFunc = undefined;
                switch (sort) {
                    case 0: sortFunc = sortFuncVotes; break;
                    case 1: sortFunc = sortFuncNegativeVotes; break;
                    case 2: sortFunc = sortFuncNew; break;
                    case 3: sortFunc = sortFuncOld; break;
                }
                var res = $(".request").sort(sortFunc);
                $(".request").remove();
                res.each( function (req, entry) {
                    $("#requestList").append(entry);
                })
            }

            function filterRequests() {
                $(".request").prop("style", "");
                $(".request").filter(function (index) {
                    switch (filter) { //inverse checks, since matches will be removed
                        case 0: return false; break;
                        case 1: return requestList[this.attributes["id"].value].statusCode != 1; break;
                        case 2: return requestList[this.attributes["id"].value].statusCode != 3; break;
                        case 3: return requestList[this.attributes["id"].value].statusCode != 2; break;
                        case 4: return requestList[this.attributes["id"].value].statusCode != 0; break;
                        case 5: return this.attributes["data-sort"].value < 0; break;
                        case 6: return this.attributes["data-sort"].value > 0; break;
                        case 7: return requestList[this.attributes["id"].value].statusCode != 4; break;
                        case 8: return requestList[this.attributes["id"].value].devresp == ""; break;
                        case 9: return !requestList[this.attributes["id"].value].self; break;
                    }
                }).prop("style", "Display: None");
            }

            function updateRequests() {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        createRequestsFromJson(this.responseText);
                        sortRequests();
                        filterRequests();
                        $(function () {
                            $('[data-toggle="tooltip"]').tooltip();
                        })
                    }
                };
                xhttp.open("GET", "/api/requests?request="+id, true);
                xhttp.send();
            }

            function updateSingleRequest(id) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        data = JSON.parse(this.responseText);
                        template = createRequest(data[id]);
                        index = $("#"+id).index();
                        $("#requestList > li:nth-child("+(index+1)+")").after(template);
                        $("#"+id)[0].remove();
                        sortRequests();
                        filterRequests();
                        requestList[id] = data[id];
                        $(function () {
                            $('[data-toggle="tooltip"]').tooltip();
                        })
                    }
                };
                xhttp.open("GET", "/api/requests?request="+id, true);
                xhttp.send();
            }

            function detailsModal(id) {
                modal_id = id;
                $("#details").remove();
                $("body").prepend($($("#modalTemplate").clone().prop("content")));

                request = requestList[id];
                modal = $("#details")
                if (request == undefined) {return;}

                modal.find("#title")[0].innerHTML = request.title;

                modes = {"":"None", "ea":"Echo Arena", "ec":"Echo Combat", "n/a":"Not Applicable"}

                modal.find(".modal-body")[0].innerHTML = modal.find(".modal-body")[0].innerHTML
                .replace("$author", request.author)
                .replace("$time", request.time)
                .replace("$status", request.status)
                .replace("$mode", modes[request.mode])
                .replace("$description", request.description)
                .replace("$points", request.up - request.down)
                .replace("$upvotes", request.up)
                .replace("$downvotes", request.down)
                .replace("$devresp", request.devresp);

                modal.find(".modal-footer")[0].innerHTML = modal.find(".modal-footer")[0].innerHTML
                .split("request.mid").join(request.mid);

                // modal.find("#shareButton")[0].attributes["onclick"].value = modal.find("#shareButton")[0].attributes["onclick"].value
                // .replace("request.mid", request.mid);

                // modal.find(".dropdown-item").toArray().forEach(function (item) {
                // 	item.attributes["onclick"].value = item.attributes["onclick"].value
                // 	.replace("request.mid", request.mid);
                // });

                {% if admin %}
                modal.find("#devresp")[0].innerHTML = request.status;
                {% endif %}

                modal.modal();
            }

            id = window.location.href.substr(window.location.href.lastIndexOf('/') + 1);
            if (isNaN(id)) id = "null";
            if (id == "") id = "null";

            updateRequests();

        </script>

        {% if admin %}
        <script>
            var selectedRequests = [];

            function setMergingOnOff() {
                let mergingOnOffCheckbox = document.getElementById("mergingOnOff");
                if(mergingOnOffCheckbox.checked) {
                    $("body").addClass("merging");
                } else {
                    $("body").removeClass("merging");
                }
            }

            function refreshMergeModalList() {
                let modalList = $("#mergeModalRequestList");
                modalList.empty();

                selectedRequests.forEach(function (selectedRequestId, i) {
                    let sourceRequest = $("#" + selectedRequestId).clone();
                    sourceRequest.find("#mergeSpan")[0].remove();
                    sourceRequest.find("#detailsSpan")[0].remove();
                    sourceRequest.find("#upButton")[0].removeAttribute("onclick");
                    sourceRequest.find("#downButton")[0].removeAttribute("onclick");
                    sourceRequest.find("#requestHeader")
                        .attr("title", "Click to expand/collapse")
                        .attr("data-toggle", "collapse")
                        .attr("data-target", "#contentWrapper" + selectedRequestId)
                        .attr("aria-expanded", "false")
                        .attr("aria-controls", "contentWrapper" + selectedRequestId)
                        .css("cursor", "pointer");
                    let requestDescription = sourceRequest.find("#description");
                    let requestFooter = sourceRequest.find("#requestFooter");
                    let requestContentWrapper = $("<div></div>")
                        .attr("id", "contentWrapper" + selectedRequestId)
                        .addClass("collapse")
                        .append(requestDescription)
                        .append(requestFooter);
                    sourceRequest.append(requestContentWrapper);

                    let listElem = $("<li></li>")
                        .addClass("d-flex w-100 justify-content-between");

                    let contentContainer = $("<div></div>")
                        .addClass("w-100")
                        .append(sourceRequest);

                    listElem.append(contentContainer);

                    let buttonContainer = $("<div></div>")
                        .addClass("d-flex flex-nowrap ml-auto");

                    if (selectedRequests.length > 1) {
                        let mergeButton = $("<button></button>")
                            .attr("type", "button")
                            .attr("title", "Merge all other selected requests to this one")
                            .click({ index: i }, showMergeConfirmModal)
                            .text("Merge to this")
                            .addClass("btn btn-warning btn-sm ml-2")
                            .css("height", "38px");

                        buttonContainer.append(mergeButton);
                    }

                    let removeButton = $("<button></button>")
                        .attr("type", "button")
                        .attr("title", "Remove from list")
                        .click({ index: i }, removeRequestFromList)
                        .text("X")
                        .addClass("btn btn-outline-danger btn-sm ml-2")
                        .css("height", "38px");

                    buttonContainer.append(removeButton);

                    listElem.append(buttonContainer);

                    modalList.append(listElem);
                });
            }

            function addRequestToList(sender) {
                let requestId = sender.attributes["requestId"].value;
                if (selectedRequests && !selectedRequests.some(sr => sr == requestId)) {
                    selectedRequests.push(requestId);
                    setSelectToMergeButtonVisibility(requestId, false);
                }
                setMergeModalButtonVisibility();
            }

            function removeRequestFromList(event) {
                let removedRequestId = selectedRequests.splice(event.data.index, 1);
                refreshMergeModalList();
                setMergeModalButtonVisibility();
                setSelectToMergeButtonVisibility(removedRequestId, true);
                if (selectedRequests.length < 1) {
                    $("#mergeModal").modal('hide');
                }
            }

            function clearSelectionList() {
                let tempSelectedRequests = selectedRequests;
                selectedRequests = [];
                refreshMergeModalList();
                setMergeModalButtonVisibility();
                tempSelectedRequests.forEach(function (requestId, i) {
                    setSelectToMergeButtonVisibility(requestId, true);
                });
                $("#mergeModal").modal('hide');
            }

            function setSelectToMergeButtonVisibility(requestId, showButton) {
                let button = $("#requestList #" + requestId).find("#selectToMergeButton");
                if(showButton) {
                    button.removeClass("d-none");
                } else {
                    button.addClass("d-none");
                }
            }

            function refreshConfirmMergeModalList(targetId) {
                let modalTargetRequest = $("#mergeConfirmModalTargetRequest");
                modalTargetRequest.empty();
                let modalList = $("#mergeConfirmModalRequestList");
                modalList.empty();

                if(!targetId)
                    return;

                let targetRequestData = getRequestElementData(targetId);
                let votesUpSum = targetRequestData.votesUp;
                let votesDownSum = targetRequestData.votesDown;

                let listElem = $("<li></li>")
                    .addClass("d-flex w-100 mb-1 pl-3");

                let votesUpElement = $("<div></div>")
                    .text(targetRequestData.votesUp)
                    .addClass("ml-1 btn btn-sm btn-outline-success")
                    .css("width", "3rem");

                listElem.append(votesUpElement);

                let votesDownElement = $("<div></div>")
                    .text(targetRequestData.votesDown)
                    .addClass("ml-1 btn btn-sm btn-outline-danger")
                    .css("width", "3rem");

                listElem.append(votesDownElement);

                let originalRequestTitle = $("<div></div>")
                    .text("[original] " + targetRequestData.title.text())
                    .addClass("ml-2")
                    .css("font-style", "italic");
                
                listElem.append(originalRequestTitle);

                modalList.append(listElem);

                selectedRequests.forEach(function (selectedRequestId, i) {
                    if(selectedRequestId == targetId)
                        return;

                    let requestData = getRequestElementData(selectedRequestId);
                    votesUpSum += requestData.votesUp;
                    votesDownSum += requestData.votesDown;

                    let listElem = $("<li></li>")
                        .addClass("d-flex w-100 mb-1");

                    let listSymbol = $("<div></div>")
                        .text("+")
                        .addClass("listSymbol");

                    listElem.append(listSymbol);

                    let votesUpElement = $("<div></div>")
                        .text(requestData.votesUp)
                        .addClass("ml-1 btn btn-sm btn-outline-success")
                        .css("width", "3rem");

                    listElem.append(votesUpElement);

                    let votesDownElement = $("<div></div>")
                        .text(requestData.votesDown)
                        .addClass("ml-1 btn btn-sm btn-outline-danger")
                        .css("width", "3rem");

                    listElem.append(votesDownElement);

                    requestData.title.addClass("ml-2");
                    listElem.append(requestData.title);

                    modalList.append(listElem);
                });

                let votesUpTargetElement = $("<div></div>")
                    .text(votesUpSum)
                    .addClass("ml-1 btn btn-outline-success")
                    .css("width", "4rem");

                modalTargetRequest.append(votesUpTargetElement);

                let votesDownTargetElement = $("<div></div>")
                    .text(votesDownSum)
                    .addClass("ml-1 btn btn-outline-danger")
                    .css("width", "4rem");

                modalTargetRequest.append(votesDownTargetElement);

                targetRequestData.title.addClass("ml-2");
                modalTargetRequest.append(targetRequestData.title);
            }

            function getRequestElementData(requestId) {
                let request = $("#" + requestId);
                let requestElement = request[0];
                let votesUp = Number(requestElement.dataset.votesup);
                let votesDown = Number(requestElement.dataset.votesdown);
                let title = request.find("#title").clone();

                let result = { title: title, votesUp: votesUp, votesDown: votesDown };

                return result;
            }

            function showMergeConfirmModal(event) {
                let targetIndex = event.data.index;
                let targetId = selectedRequests[targetIndex];
                refreshConfirmMergeModalList(targetId);
                $("#mergeConfirmModal").find("#confirmMergeButton")[0]
                    .attributes["data-targetindex"].value = targetIndex;

                $("#mergeModal").modal('hide');
                setTimeout(() => {
                    $("#mergeConfirmModal").modal('show');
                }, 100);
            }

            function cancelMerge() {
                $("#mergeConfirmModal").modal('hide');
                setTimeout(() => {
                    $("#mergeModal").modal('show');
                }, 100);
            }

            function mergeSelectedToTarget(event) {
                let targetIndex = Number(event.target.dataset.targetindex);
                if(isNaN(targetIndex)) {
                    return;
                }
                
                let targetId = selectedRequests.splice(targetIndex, 1)[0];
                let payload = { id: targetId, ids_from: selectedRequests }
                let payloadJson = JSON.stringify(payload);
                
                let xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.responseText == "OK") {
                        updateSingleRequest(targetId);
                        setSelectToMergeButtonVisibility(targetId, true);
                        selectedRequests.forEach(sr => {
                            updateSingleRequest(sr);
                            setSelectToMergeButtonVisibility(sr, true);
                        });
                        selectedRequests = [];
                        refreshMergeModalList();
                        refreshConfirmMergeModalList();
                        setMergeModalButtonVisibility();
                        $("#mergeConfirmModal").modal('hide');
                        console.log("success");
                    }
                };
                // xhttp.open("POST", "/api/merge", true);
                // xhttp.send(payloadJson);
                console.log("merging");
            }

            function setMergeModalButtonVisibility() {
                $("#mergeModalOpen").css("display", selectedRequests.length > 0 ? "" : "none");
            }

            setMergeModalButtonVisibility();
        </script>
        {% endif %}

        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

        {% if submit is not none %}
        <script type="text/javascript">
            $("#requestmodal").modal();
        </script>
        {% endif %}
    </body>
</html>
